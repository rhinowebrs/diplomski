{% extends "base.html" %}

{% block title %}Add Password{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Add Password</h2>
    <form method="POST" action="{{ url_for('main.add_password') }}">
        {{ form.hidden_tag() }}

        <div class="form-group">
            {{ form.name.label }}
            {{ form.name(class="form-control") }}
        </div>

        <div class="form-group">
            {{ form.url.label }}
            {{ form.url(class="form-control", id="urlField") }}
        </div>

        <div class="form-check">
            {{ form.no_url(class="form-check-input", id="noUrlCheckbox") }}
            {{ form.no_url.label(class="form-check-label") }}
        </div>

        <div class="form-group password-group">
            {{ form.password.label }}
            <div class="password-container">
                {{ form.password(class="form-control", id="passwordField", maxlength="32") }}
                <span class="toggle-password" id="togglePassword" onclick="togglePassword()">
                    <i class="fa-solid fa-eye-slash"></i>
                </span>
            </div>
        </div>

        <div class="form-group">
            <button type="button" class="btn btn-secondary" id="generatePasswordBtn" onclick="handleGeneratePassword()">
                Generate Password
            </button>
        </div>

        <div class="form-group">
            {{ form.submit(class="btn btn-primary") }}
        </div>
    </form>
</div>

<script>
    const noUrlCheckbox = document.getElementById('noUrlCheckbox');
    const urlField = document.getElementById('urlField');

    function syncUrlRequirement() {
        if (noUrlCheckbox.checked) {
            urlField.disabled = true;
            urlField.required = false;
            urlField.value = '';
        } else {
            urlField.disabled = false;
            urlField.required = true;
        }
    }

    noUrlCheckbox.addEventListener('change', syncUrlRequirement);
    // Initialize on load
    syncUrlRequirement();

    function togglePassword() {
        let passwordField = document.getElementById("passwordField");
        let toggleIcon = document.getElementById("togglePassword").querySelector("i");

        if (passwordField.type === "password") {
            passwordField.type = "text";
            toggleIcon.classList.remove("fa-eye-slash");
            toggleIcon.classList.add("fa-eye");
        } else {
            passwordField.type = "password";
            toggleIcon.classList.remove("fa-eye");
            toggleIcon.classList.add("fa-eye-slash");
        }
    }

    function setPasswordVisible() {
        const passwordField = document.getElementById("passwordField");
        const toggleIcon = document.getElementById("togglePassword").querySelector("i");
        if (passwordField.type !== "text") {
            passwordField.type = "text";
            toggleIcon.classList.remove("fa-eye-slash");
            toggleIcon.classList.add("fa-eye");
        }
    }

    function generateRandomPassword(length = 16) {
        const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()-_=+[]{};:,.?/";
        let password = "";
        if (window.crypto && window.crypto.getRandomValues) {
            const randomValues = new Uint32Array(length);
            window.crypto.getRandomValues(randomValues);
            for (let i = 0; i < length; i++) {
                password += charset[randomValues[i] % charset.length];
            }
        } else {
            for (let i = 0; i < length; i++) {
                password += charset[Math.floor(Math.random() * charset.length)];
            }
        }
        return password;
    }

    function handleGeneratePassword() {
        const passwordField = document.getElementById("passwordField");
        passwordField.value = generateRandomPassword(16);
        setPasswordVisible();
    }
</script>

{% endblock %}
