{% extends "base.html" %}
{% block title %}Passwords{% endblock %}
{% block content %}
    <div class="dashboard-top">
        <div class="left">
            <h2>Manage Your Passwords</h2>
            <p>Keep your credentials safe and organized.</p>
        </div>
        <div class="right"></div>
    </div>

    <div class="passwords-section">
        {% if passwords and passwords|length > 0 %}
            <div class="password-list">
                {% for pwd in passwords %}
                    <div class="password-card" data-password-id="{{ pwd.id }}">
                        <button class="lock-btn" title="Reveal password" aria-label="Reveal password">
                            <i class="fa-solid fa-lock"></i>
                        </button>
                        <button class="delete-btn" title="Delete password" aria-label="Delete password">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                        <div class="password-name">{{ pwd.name }}</div>
                        {% if pwd.url and pwd.url|lower != 'local' %}
                        <div class="password-url">
                            {% set url_val = pwd.url %}
                            {% if not (pwd.url.startswith('http://') or pwd.url.startswith('https://')) %}
                                {% set url_val = 'https://' + pwd.url %}
                            {% endif %}
                            <a href="{{ url_val }}" target="_blank" rel="noopener noreferrer"><i class="fa-solid fa-link"></i> link</a>
                        </div>
                        {% else %}
                        <div class="password-url"><span class="no-link">no link</span></div>
                        {% endif %}
                        <div class="password-value" style="display: none;">
                            <span class="password-label">Password:</span>
                            <span class="password-text"></span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">No passwords yet. Use "Add Password" to create one.</div>
        {% endif %}
    </div>

    <div id="revealModal" class="modal-overlay hidden" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <h3 id="modalTitle">Confirm Your Password</h3>
            <p id="modalSub" class="modal-sub">Enter your account password to reveal the selected password.</p>
            <input type="password" id="accountPasswordInput" class="form-control" placeholder="Account password">
            <div id="modalError" class="alert alert-danger" style="display:none; margin-top: 12px;"></div>
            <div class="modal-actions">
                <button id="modalCancel" class="btn btn-secondary" type="button">Cancel</button>
                <button id="modalConfirm" class="btn" type="button">Reveal</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const modal = document.getElementById('revealModal');
            const input = document.getElementById('accountPasswordInput');
            const btnCancel = document.getElementById('modalCancel');
            const btnConfirm = document.getElementById('modalConfirm');
            const errorBox = document.getElementById('modalError');

            let selectedId = null;
            let selectedCard = null;
            let selectedAction = 'reveal'; // 'reveal' | 'delete'

            function openModal(cardEl, action) {
                selectedCard = cardEl;
                selectedId = parseInt(cardEl.getAttribute('data-password-id'));
                selectedAction = action || 'reveal';
                errorBox.style.display = 'none';
                errorBox.textContent = '';
                input.value = '';
                const modalTitle = document.getElementById('modalTitle');
                const modalSub = document.getElementById('modalSub');
                const modalConfirm = document.getElementById('modalConfirm');
                if (selectedAction === 'delete') {
                    modalTitle.textContent = 'Confirm Deletion';
                    modalSub.textContent = 'Enter your account password to delete this password.';
                    modalConfirm.textContent = 'Delete';
                } else {
                    modalTitle.textContent = 'Confirm Your Password';
                    modalSub.textContent = 'Enter your account password to reveal the selected password.';
                    modalConfirm.textContent = 'Reveal';
                }
                modal.classList.remove('hidden');
                modal.setAttribute('aria-hidden', 'false');
                setTimeout(() => input.focus(), 0);
            }

            function closeModal() {
                modal.classList.add('hidden');
                modal.setAttribute('aria-hidden', 'true');
                selectedId = null;
                selectedCard = null;
                input.value = '';
            }

            document.addEventListener('click', function(e) {
                const lockBtn = e.target.closest('.lock-btn');
                if (lockBtn) {
                    const card = lockBtn.closest('.password-card');
                    if (card) {
                        // If already revealed, hide without prompting again
                        if (card.classList.contains('revealed')) {
                            const valueEl = card.querySelector('.password-value');
                            const icon = card.querySelector('.lock-btn i');
                            if (valueEl) valueEl.style.display = 'none';
                            if (icon) {
                                icon.classList.remove('fa-lock-open');
                                icon.classList.add('fa-lock');
                            }
                            card.classList.remove('revealed');
                            lockBtn.setAttribute('title', 'Reveal password');
                        } else {
                            openModal(card, 'reveal');
                        }
                    }
                }

                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const card = deleteBtn.closest('.password-card');
                    if (card) openModal(card, 'delete');
                }

                if (e.target === modal) {
                    // Click outside modal closes it
                    closeModal();
                }
            });

            btnCancel.addEventListener('click', closeModal);

            async function reveal() {
                if (!selectedId) return;
                const accountPassword = input.value || '';
                btnConfirm.disabled = true;
                errorBox.style.display = 'none';
                errorBox.textContent = '';
                try {
                    const res = await fetch("{{ url_for('main.reveal_password') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password_id: selectedId, account_password: accountPassword })
                    });
                    const data = await res.json();
                    if (!res.ok || !data.success) {
                        throw new Error(data.message || 'Failed to reveal password.');
                    }
                    const valueEl = selectedCard.querySelector('.password-value');
                    const textEl = selectedCard.querySelector('.password-text');
                    if (textEl && valueEl) {
                        textEl.textContent = data.password;
                        valueEl.style.display = 'block';
                        const icon = selectedCard.querySelector('.lock-btn i');
                        if (icon) {
                            icon.classList.remove('fa-lock');
                            icon.classList.add('fa-lock-open');
                        }
                        selectedCard.classList.add('revealed');
                        const btn = selectedCard.querySelector('.lock-btn');
                        if (btn) btn.setAttribute('title', 'Hide password');
                    }
                    closeModal();
                } catch (err) {
                    errorBox.textContent = err.message;
                    errorBox.style.display = 'block';
                } finally {
                    btnConfirm.disabled = false;
                }
            }

            async function removePassword() {
                if (!selectedId) return;
                const accountPassword = input.value || '';
                btnConfirm.disabled = true;
                errorBox.style.display = 'none';
                errorBox.textContent = '';
                try {
                    const res = await fetch("{{ url_for('main.delete_password') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password_id: selectedId, account_password: accountPassword })
                    });
                    const data = await res.json();
                    if (!res.ok || !data.success) {
                        throw new Error(data.message || 'Failed to delete password.');
                    }
                    // Remove the card from the DOM
                    if (selectedCard && selectedCard.parentNode) {
                        selectedCard.parentNode.removeChild(selectedCard);
                    }
                    // If no more cards, show empty state
                    if (!document.querySelector('.password-card')) {
                        const container = document.querySelector('.passwords-section');
                        if (container) {
                            const empty = document.createElement('div');
                            empty.className = 'empty-state';
                            empty.textContent = 'No passwords yet. Use "Add Password" to create one.';
                            container.appendChild(empty);
                        }
                    }
                    closeModal();
                } catch (err) {
                    errorBox.textContent = err.message;
                    errorBox.style.display = 'block';
                } finally {
                    btnConfirm.disabled = false;
                }
            }

            function onConfirm() {
                if (selectedAction === 'delete') return removePassword();
                return reveal();
            }

            btnConfirm.addEventListener('click', onConfirm);
            input.addEventListener('keydown', function(e){
                if (e.key === 'Enter') onConfirm();
                if (e.key === 'Escape') closeModal();
            });
        })();
    </script>
{% endblock %}
